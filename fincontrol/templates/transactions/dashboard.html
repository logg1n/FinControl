{% extends "base.html" %}
{% block title %}Мои финансы | FinControl{% endblock %}
{% block content %}
<h2 class="mb-4">Мои финансы</h2>

<!-- Форма фильтров -->
<form id="filters-form" method="get" class="card p-3 mb-4 shadow-sm">
    <div class="row g-3">
        <div class="col-sm-6 col-md-3">
            <label class="form-label">Дата от:</label>
            <input type="date" name="date_from" value="{{ request.GET.date_from }}" class="form-control">
        </div>
        <div class="col-sm-6 col-md-3">
            <label class="form-label">Дата до:</label>
            <input type="date" name="date_to" value="{{ request.GET.date_to }}" class="form-control">
        </div>
        <div class="col-md-3">
            <label class="form-label">Категория:</label>
            <select name="category" class="form-select">
                <option value="">—</option>
                {% for c in categories %}
                    <option value="{{ c }}" {% if request.GET.category == c %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">Валюта:</label>
            <select name="currency" class="form-select">
                <option value="">—</option>
                {% for code, name in currencies %}
                    <option value="{{ code }}" {% if request.GET.currency == code %}selected{% endif %}>
                        {{ code }} — {{ name }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="mt-3">
        <button type="submit" class="btn btn-primary me-2"><i class="bi bi-funnel"></i> Применить</button>
        <a href="{% url 'transaction_list' %}" class="btn btn-outline-secondary"><i class="bi bi-x-circle"></i> Сбросить</a>
    </div>
</form>

<!-- KPI + графики -->
<div id="kpi-block" class="mb-4">
    <em class="text-muted">Загрузка аналитики...</em>
</div>

<h3 class="mb-3">Транзакции</h3>
<div class="table-responsive shadow-sm">
    <table class="table table-striped table-hover align-middle mb-0">
        <thead class="table-primary">
            <tr>
                <th>Дата</th>
                <th>Сумма</th>
                <th>Валюта</th>
                <th>Тип</th>
                <th>Категория</th>
                <th>Подкатегория</th>
                <th>Способ оплаты</th>
                <th>Метка</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody id="transactions-body">
            <tr>
                <td colspan="9" class="text-center text-muted"><em>Загрузка...</em></td>
            </tr>
        </tbody>
    </table>
</div>

{% block extra_js %}
<script>
// Вставка HTML с выполнением <script>
function insertWithScripts(container, html) {
    container.innerHTML = html;
    container.querySelectorAll("script").forEach(oldScript => {
        const newScript = document.createElement("script");
        if (oldScript.src) {
            newScript.src = oldScript.src;
        } else {
            newScript.textContent = oldScript.textContent;
        }
        document.body.appendChild(newScript);
        document.body.removeChild(newScript);
    });
}

function loadDashboard() {
    const params = new URLSearchParams(new FormData(document.getElementById("filters-form")));
    fetch("{% url 'dashboard_block' %}?" + params.toString(), {credentials: "same-origin"})
        .then(r => r.text())
        .then(html => insertWithScripts(document.getElementById("kpi-block"), html))
        .catch(err => {
            document.getElementById("kpi-block").innerHTML = "<p class='text-danger'>Ошибка загрузки аналитики</p>";
            console.error(err);
        });
}

function loadTransactions() {
    const params = new URLSearchParams(new FormData(document.getElementById("filters-form")));
    fetch("{% url 'transactions_table_block' %}?" + params.toString(), {credentials: "same-origin"})
        .then(r => r.text())
        .then(html => { document.getElementById("transactions-body").innerHTML = html; })
        .catch(err => {
            document.getElementById("transactions-body").innerHTML =
                "<tr><td colspan='9' class='text-danger text-center'>Ошибка загрузки таблицы</td></tr>";
            console.error(err);
        });
}

function refreshAll() {
    loadDashboard();
    loadTransactions();
}

document.getElementById("filters-form").addEventListener("submit", function(e) {
    e.preventDefault();
    refreshAll();
});

// Загружаем при старте
refreshAll();
</script>
{% endblock %}
{% endblock %}
