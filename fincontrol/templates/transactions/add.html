{% extends "base.html" %}
{% block content %}
<h2>{% if form.instance.pk %}Редактировать{% else %}Добавить{% endif %} транзакцию</h2>

<form id="transaction-form" method="post">
    {% csrf_token %}

    <p>{{ form.amount.label }}: {{ form.amount }}</p>
    <p>{{ form.date.label }}: {{ form.date }}</p>
    <p>{{ form.type.label }}: {{ form.type }}</p>
    <p>{{ form.payment_method.label }}: {{ form.payment_method }}</p>

    <p>
        <label for="currency_search">Валюта:</label><br>
        <input type="text" id="currency_search" placeholder="Поиск валюты..." style="width:240px;">
        <br>
        <select id="id_currency" name="currency" size="8" style="width:240px;">
            {% for code, name in currencies %}
                <option value="{{ code }}" {% if form.instance.currency == code %}selected{% endif %}>
                    {{ code }} — {{ name }}
                </option>
            {% endfor %}
        </select>
    </p>

    <p>
        <label for="id_category">Категория:</label><br>
        <select id="id_category" name="category" style="width:240px;">
            <option value="">—</option>
            {% for c in categories %}
                <option value="{{ c }}" {% if form.instance.category == c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
            <option value="__add_new__">+ Добавить категорию…</option>
        </select>
    </p>

    <p>
        <label for="id_subcategory">Подкатегория:</label><br>
        <select id="id_subcategory" name="subcategory" style="width:240px;">
            <option value="">—</option>
            {% if form.instance.subcategory %}
                <option value="{{ form.instance.subcategory }}" selected>{{ form.instance.subcategory }}</option>
            {% endif %}
            <option value="__add_new__">+ Добавить подкатегорию…</option>
        </select>
    </p>

    <p>{{ form.tag.label }}: {{ form.tag }}</p>

    <button type="submit">Сохранить</button>
    <a href="{% url 'transaction_list' %}" style="margin-left:10px;">Отмена</a>
</form>

<script>
// ===== CSRF =====
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}
const csrfToken = getCookie('csrftoken');

// ===== Валюта: поиск + UPPERCASE =====
const searchInput = document.getElementById("currency_search");
const currencySelect = document.getElementById("id_currency");

function filterCurrencyOptions(query) {
    const q = (query || "").toUpperCase().trim();
    let firstVisible = null;
    for (let option of currencySelect.options) {
        const code = option.value.toUpperCase();
        const text = option.textContent.toUpperCase();
        const visible = (!q) || code.startsWith(q) || text.startsWith(q) || text.includes(q);
        option.style.display = visible ? "" : "none";
        if (visible && !firstVisible) firstVisible = option;
    }
    return firstVisible;
}

searchInput.addEventListener("input", function() {
    filterCurrencyOptions(this.value);
});

searchInput.addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
        e.preventDefault();
        const first = filterCurrencyOptions(this.value);
        if (first) {
            currencySelect.value = first.value.toUpperCase();
        }
    }
});

// На всякий случай приводим к верхнему регистру на изменении/отправке
currencySelect.addEventListener("change", function() {
    if (this.value) this.value = this.value.toUpperCase();
});

document.getElementById("transaction-form").addEventListener("submit", function() {
    if (currencySelect.value) currencySelect.value = currencySelect.value.toUpperCase();
});

// ===== Категории/подкатегории (AJAX) =====
const categorySelect = document.getElementById("id_category");
const subcategorySelect = document.getElementById("id_subcategory");

// Обновление списка подкатегорий по выбранной категории
function refreshSubcategories(category, selected = "") {
    if (!category) {
        subcategorySelect.innerHTML = '<option value="">—</option><option value="__add_new__">+ Добавить подкатегорию…</option>';
        return;
    }
    const url = "{% url 'subcategories_json' %}?category=" + encodeURIComponent(category);
    fetch(url, { credentials: "same-origin" })
        .then(r => r.json())
        .then(data => {
            subcategorySelect.innerHTML = '<option value="">—</option>';
            (data.subcategories || []).forEach(s => {
                const opt = new Option(s, s);
                subcategorySelect.appendChild(opt);
            });
            subcategorySelect.appendChild(new Option("+ Добавить подкатегорию…", "__add_new__"));
            if (selected) subcategorySelect.value = selected;
        })
        .catch(() => {
            alert("Не удалось загрузить подкатегории");
        });
}

// Добавление новой категории
function addNewCategoryFlow() {
    const name = prompt("Введите название новой категории:");
    if (!name) {
        categorySelect.value = "";
        return;
    }
    fetch("{% url 'category_add_ajax' %}", {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken, "Content-Type": "application/json" },
        body: JSON.stringify({ name: name })
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success) throw new Error(data.error || "Ошибка добавления категории");
        // Перестроим список категорий
        categorySelect.innerHTML = "";
        categorySelect.appendChild(new Option("—", ""));
        (data.categories || []).forEach(c => {
            categorySelect.appendChild(new Option(c, c));
        });
        categorySelect.appendChild(new Option("+ Добавить категорию…", "__add_new__"));
        categorySelect.value = name;
        refreshSubcategories(name);
    })
    .catch(err => {
        alert(err.message || "Ошибка добавления категории");
        categorySelect.value = "";
    });
}

// Добавление новой подкатегории
function addNewSubcategoryFlow() {
    const category = categorySelect.value;
    if (!category) {
        alert("Сначала выберите категорию");
        subcategorySelect.value = "";
        return;
    }
    const name = prompt("Введите название новой подкатегории:");
    if (!name) {
        subcategorySelect.value = "";
        return;
    }
    fetch("{% url 'subcategory_add_ajax' %}", {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken, "Content-Type": "application/json" },
        body: JSON.stringify({ category: category, name: name })
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success) throw new Error(data.error || "Ошибка добавления подкатегории");
        // Перестроим список подкатегорий
        subcategorySelect.innerHTML = '<option value="">—</option>';
        (data.subcategories || []).forEach(s => {
            subcategorySelect.appendChild(new Option(s, s));
        });
        subcategorySelect.appendChild(new Option("+ Добавить подкатегорию…", "__add_new__"));
        subcategorySelect.value = name;
    })
    .catch(err => {
        alert(err.message || "Ошибка добавления подкатегории");
        subcategorySelect.value = "";
    });
}

// Слушатели изменений
categorySelect.addEventListener("change", function() {
    if (this.value === "__add_new__") {
        addNewCategoryFlow();
    } else {
        refreshSubcategories(this.value);
    }
});

subcategorySelect.addEventListener("change", function() {
    if (this.value === "__add_new__") {
        addNewSubcategoryFlow();
    }
});

// ===== Инициализация при загрузке (для режима редактирования) =====
document.addEventListener("DOMContentLoaded", function() {
    const initialCategory = categorySelect.value;
    const initialSubcategory = "{{ form.instance.subcategory|default_if_none:''|escapejs }}";
    if (initialCategory) {
        // Если подкатегория уже отрендерена как selected сервером — всё ок,
        // но перестроим список из актуального справочника и попробуем сохранить выбор.
        refreshSubcategories(initialCategory, initialSubcategory);
    }
    // Применим фильтрацию валют под текущее значение поиска (если вдруг сохранено автозаполнением)
    filterCurrencyOptions(searchInput.value);
});
</script>
{% endblock %}
```